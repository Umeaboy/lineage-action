name: build-for-o1s-self-hosted

on: workflow_dispatch

jobs:
  build-for-o1s:
    runs-on: ubuntu-latest
    steps:
    - name: Adding the repo binary to $PATH
        run: |
          export PATH=$PATH:~/bin
          mkdir -p ~/android/lineage
          cd ~/android/lineage

          - name: Installing the "repo" Tool
        run: |
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          
          - name: Authenticating "repo" with GitHub account
          run: |
          git config --global user.email "lovaren@gmail.com"
          git config --global user.name "Kristoffer Grundstr√∂m"

           - name: Setting up a local repo
           run: |
          ~/bin/repo init -u https://github.com/LineageOS/android.git -b lineage-22.1 --git-lfs --depth=1
          
          - name: Enabling caching
          run: |
          export USE_CCACHE=1
          export CCACHE_EXEC=/usr/bin/ccache
          ccache -M 25G
          
          - name: Syncing sources
          run: |
          ~/bin/repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

          - name: Installing dependencies
          run: |
          sudo apt-get install bc bison build-essential ccache curl flex g++-multilib gcc-multilib git git-lfs gnupg gperf imagemagick protobuf-compiler python3-protobuf lib32readline-dev lib32z1-dev libdw-dev libelf-dev libgnutls28-dev lz4 libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev
          wget https://archive.ubuntu.com/ubuntu/pool/universe/n/ncurses/libtinfo5_6.3-2_amd64.deb
          sudo dpkg -i libtinfo5_6.3-2_amd64.deb
          rm -f libtinfo5_6.3-2_amd64.deb
          wget https://archive.ubuntu.com/ubuntu/pool/universe/n/ncurses/libncurses5_6.3-2_amd64.deb
          sudo dpkg -i libncurses5_6.3-2_amd64.deb
          rm -f libncurses5_6.3-2_amd64.deb

          - name: Setting up the build environment
          run: |
            cd ~/android/lineage
            mkdir -p device/samsung/o1s kernel/samsung/o1s vendor/samsung/o1s
            git clone https://github.com/exynos-republic/android_device_samsung_universal2100-common -b lineage-22.1 device/samsung/universal2100-common
            git clone https://github.com/exynos-republic/android_device_samsung_o1s -b lineage-22.1 device/samsung/o1s
            git clone https://github.com/exynos-republic/android_device_samsung_slsi_sepolicy -b lineage-22.1 device/samsung_slsi/sepolicy
            git clone https://github.com/exynos-republic/android_kernel_samsung_universal2100 -b lineage-22.1 kernel/samsung/universal2100
            git clone https://github.com/exynos-republic/android_vendor_samsung_o1s -b lineage-22.1 vendor/samsung/o1s
            git clone https://github.com/exynos-republic/android_vendor_samsung_universal2100-common -b lineage-22.1 vendor/samsung/universal2100-common
            git clone https://github.com/exynos-republic/android_hardware_samsung -b lineage-22.1 hardware/samsung
            git clone https://github.com/exynos-republic/android_hardware_samsung_slsi-linaro_graphics -b lineage-22.1 hardware/samsung_slsi-linaro/graphics
            git clone https://github.com/exynos-republic/android_hardware_samsung_slsi-linaro_exynos -b lineage-22.1 hardware/samsung_slsi-linaro/exynos
            git clone https://github.com/exynos-republic/android_hardware_samsung_slsi-linaro_config -b lineage-22.1 hardware/samsung_slsi-linaro/config
            git clone https://github.com/exynos-republic/android_hardware_samsung_slsi-linaro_exynos5 -b lineage-22.1 hardware/samsung_slsi-linaro/exynos5
            git clone https://github.com/exynos-republic/android_hardware_samsung_slsi-linaro_openmax -b lineage-22.1 hardware/samsung_slsi-linaro/openmax
            git clone https://github.com/exynos-republic/android_hardware_samsung_slsi-linaro_codec2 -b lineage-22.1 hardware/samsung_slsi-linaro/codec2
            git clone https://github.com/exynos-republic/android_hardware_samsung_slsi-linaro_interfaces -b lineage-22.1 hardware/samsung_slsi-linaro/interfaces
            source build/envsetup.sh
            lunch lineage_o1s-userdebug
          
          - name: Starting build process
          run: |
          croot && mka bacon
          
          - name: Get current time
          uses: srfrnk/current-time@master
          id: current-time
          with:
          format: YYYY-MM-DD
          
          - name: Adding the build to Releases
          uses: softprops/action-gh-release@v1
          with:
          name: "Auto Build ${{ steps.current-time.outputs.formattedTime }}"
          tag_name: 0.01
          prerelease: false
          body: |
            This is an automatic release by GitHub Actions.
          files: |
            $OUT/recovery.img
            $OUT/lineage-*-o1s.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
